<!DOCTYPE html>
<html lang="en" style="font-family: monospace;"><head><title>[37137f627e] fix custom root web path | s4g | Boast</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"></head><body><strong><a href="../../">Repos</a> / <a href="../">s4g</a> / 37137f627e</strong><hr><pre>commit 37137f627e2f999be9d317d79ae6c6a486c0f147
Author: Nh√¢n &lt;hi@imnhan.com&gt;
Date:   Wed Jul 12 17:04:40 2023 +0700

    fix custom root web path
    
    The preview server now transparently works regardless of Root setting.

diff --git a/livereload/livereload.go b/livereload/livereload.go
index 4031248..6bd7e02 100644
--- a/livereload/livereload.go
+++ b/livereload/livereload.go
@@ -43,56 +43,59 @@ func init() {
 	)
 }
 
+func handleFunc(w http.ResponseWriter, r *http.Request) {
+	clientId := r.Header.Get(clientIdHeader)
+	state.mut.RLock()
+	shouldReload, ok := state.clients[clientId]
+	state.mut.RUnlock()
+
+	// New client: add client to state, don&#39;t reload
+	if !ok {
+		//fmt.Println(&quot;New livereload client:&quot;, clientId)
+		state.mut.Lock()
+		state.clients[clientId] = false
+		state.mut.Unlock()
+		w.Write(dontReload)
+		return
+	}
+
+	// Existing client:
+	if shouldReload {
+		w.Write(pleaseReload)
+		// On reload, the browser tab will generate another client ID,
+		// so we can safely delete the old client ID now:
+		state.mut.Lock()
+		delete(state.clients, clientId)
+		state.mut.Unlock()
+	} else {
+		w.Write(dontReload)
+	}
+}
+
 // For html pages, insert a script tag to enable livereload
-func Middleware(fsys writablefs.FS, f http.Handler) http.Handler {
+func Middleware(root string, fsys writablefs.FS, f http.Handler) http.Handler {
+
+	// Handle AJAX endpoint
+	http.HandleFunc(endpoint, handleFunc)
+
 	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
 		path := r.URL.Path
 
-		// Handle AJAX endpoint
-		if path == endpoint {
-			clientId := r.Header.Get(clientIdHeader)
-			state.mut.RLock()
-			shouldReload, ok := state.clients[clientId]
-			state.mut.RUnlock()
-
-			// New client: add client to state, don&#39;t reload
-			if !ok {
-				//fmt.Println(&quot;New livereload client:&quot;, clientId)
-				state.mut.Lock()
-				state.clients[clientId] = false
-				state.mut.Unlock()
-				w.Write(dontReload)
-				return
-			}
-
-			// Existing client:
-			if shouldReload {
-				w.Write(pleaseReload)
-				// On reload, the browser tab will generate another client ID,
-				// so we can safely delete the old client ID now:
-				state.mut.Lock()
-				delete(state.clients, clientId)
-				state.mut.Unlock()
-			} else {
-				w.Write(dontReload)
-			}
-			return
-		}
-
 		// For non-html requests, fall through to default FileServer handler
 		if !strings.HasSuffix(path, &quot;.html&quot;) &amp;&amp; !strings.HasSuffix(path, &quot;/&quot;) {
 			f.ServeHTTP(w, r)
 			return
 		}
 
-		if strings.HasSuffix(path, &quot;/&quot;) {
-			path += &quot;index.html&quot;
+		filePath := path
+
+		if strings.HasSuffix(filePath, &quot;/&quot;) {
+			filePath += &quot;index.html&quot;
 		}
 
-		// Filesystem access doesn&#39;t expect leading slash &quot;/&quot;
-		path = strings.TrimPrefix(path, &quot;/&quot;)
+		filePath = strings.TrimPrefix(filePath, root)
 
-		originalContent, err := fs.ReadFile(fsys, path)
+		originalContent, err := fs.ReadFile(fsys, filePath)
 		if err != nil {
 			f.ServeHTTP(w, r)
 			return
@@ -102,6 +105,7 @@ func Middleware(fsys writablefs.FS, f http.Handler) http.Handler {
 	})
 }
 
+// Tell current browser tabs to reload
 func Trigger() {
 	state.mut.Lock()
 	defer state.mut.Unlock()
diff --git a/main.go b/main.go
index 0b7ad16..6d5f2e7 100644
--- a/main.go
+++ b/main.go
@@ -82,7 +82,7 @@ func handleServeCmd(folder, port string) {
 
 	fsys := writablefs.WriteDirFS(absolutePath)
 
-	regenerate(fsys)
+	site := regenerate(fsys)
 
 	// TODO: only rebuild necessary bits instead of regenerating
 	// the whole thing. To do that I&#39;ll probably need to:
@@ -98,18 +98,25 @@ func handleServeCmd(folder, port string) {
 	})
 	defer closeWatcher()
 
-	println(&quot;Serving local website at http://localhost:&quot; + port)
-	http.Handle(&quot;/&quot;, livereload.Middleware(fsys, http.FileServer(http.FS(fsys))))
+	println(&quot;Serving local website at http://localhost:&quot; + port + site.Root)
+	http.Handle(
+		site.Root,
+		livereload.Middleware(
+			site.Root,
+			fsys,
+			http.StripPrefix(site.Root, http.FileServer(http.FS(fsys))),
+		),
+	)
 	err = http.ListenAndServe(&quot;127.0.0.1:&quot;+port, nil)
 	if err != nil {
 		panic(err)
 	}
 }
 
-func regenerate(fsys writablefs.FS) {
+func regenerate(fsys writablefs.FS) (site SiteMetadata) {
 	defer timer(&quot;Took %s&quot;)()
 
-	site := ReadSiteMetadata(fsys)
+	site = ReadSiteMetadata(fsys)
 	articles := findArticles(fsys)
 
 	if len(articles) == 0 {
@@ -160,13 +167,15 @@ func regenerate(fsys writablefs.FS) {
 
 	fsys.WriteFile(
 		FeedPath,
-		generateFeed(site, articlesInFeed, site.HomePath+FeedPath),
+		generateFeed(site, articlesInFeed, site.Root+FeedPath),
 	)
 	generatedFiles[FeedPath] = true
 	fmt.Println(&quot;Generated&quot;, FeedPath)
 
 	DeleteOldGeneratedFiles(fsys, generatedFiles)
 	WriteManifest(fsys, generatedFiles)
+
+	return
 }
 
 type Article struct {
@@ -243,7 +252,7 @@ func (a *Article) WriteHtmlFile(
 		Title:         fmt.Sprintf(&quot;%s | %s&quot;, a.Title, site.Name),
 		Post:          a,
 		ArticlesInNav: articlesInNav,
-		Feed:          site.HomePath + FeedPath,
+		Feed:          site.Root + FeedPath,
 		Now:           time.Now(),
 		StartYear:     startYear,
 	})
@@ -288,7 +297,7 @@ func WriteHomePage(
 		Title:          fmt.Sprintf(&quot;%s - %s&quot;, site.Name, site.Tagline),
 		ArticlesInFeed: articlesInFeed,
 		ArticlesInNav:  articlesInNav,
-		Feed:           site.HomePath + FeedPath,
+		Feed:           site.Root + FeedPath,
 		Now:            time.Now(),
 		StartYear:      startYear,
 	})
diff --git a/metadata.go b/metadata.go
index f7fcc42..caadd06 100644
--- a/metadata.go
+++ b/metadata.go
@@ -17,7 +17,7 @@ type SiteMetadata struct {
 	Address      string
 	Name         string
 	Tagline      string
-	HomePath     string
+	Root         string
 	ShowFooter   bool
 	GenerateHome bool
 	AuthorName   string
@@ -36,7 +36,7 @@ type ArticleMetadata struct {
 
 func NewSiteMetadata() SiteMetadata {
 	return SiteMetadata{
-		HomePath:     &quot;/&quot;,
+		Root:         &quot;/&quot;,
 		ShowFooter:   true,
 		GenerateHome: true,
 	}
@@ -51,6 +51,10 @@ func ReadSiteMetadata(fsys writablefs.FS) SiteMetadata {
 	}
 
 	UnmarshalMetadata(data, &amp;sm)
+
+	// normalize root path to always include leading &amp; trailing slashes
+	sm.Root = fmt.Sprintf(&quot;/%s/&quot;, strings.Trim(sm.Root, &quot;/&quot;))
+
 	return sm
 }
 
diff --git a/theme/base.tmpl b/theme/base.tmpl
index 6edbe18..5792618 100644
--- a/theme/base.tmpl
+++ b/theme/base.tmpl
@@ -6,7 +6,7 @@
   &lt;title&gt;{{.Title}}&lt;/title&gt;
   &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
   &lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom feed&quot; href=&quot;{{.Feed}}&quot;&gt;
-  &lt;link rel=&quot;stylesheet&quot; href=&quot;{{.Site.HomePath}}_theme/base.css&quot;&gt;
+  &lt;link rel=&quot;stylesheet&quot; href=&quot;{{.Site.Root}}_theme/base.css&quot;&gt;
   {{- template &quot;head&quot; .}}
 &lt;/head&gt;
 
diff --git a/theme/home.tmpl b/theme/home.tmpl
index a928083..d2b8297 100644
--- a/theme/home.tmpl
+++ b/theme/home.tmpl
@@ -9,12 +9,12 @@
 &lt;hr&gt;
 
 &lt;div class=&quot;pages&quot;&gt;
-  &lt;a href=&quot;{{.Site.HomePath}}&quot;&gt;Home&lt;/a&gt;
+  &lt;a href=&quot;{{.Site.Root}}&quot;&gt;Home&lt;/a&gt;
 {{- range .ArticlesInNav}}
   &lt;a href=&quot;{{.WebPath}}&quot;&gt;{{.Title}}&lt;/a&gt;
 {{- end}}
   &lt;a class=&quot;feed-link&quot; href=&quot;{{.Feed}}&quot;&gt;
-    &lt;img src=&quot;{{.Site.HomePath}}_theme/feed.svg&quot; alt=&quot;Atom Feed&quot; title=&quot;Atom Feed&quot;&gt;
+    &lt;img src=&quot;{{.Site.Root}}_theme/feed.svg&quot; alt=&quot;Atom Feed&quot; title=&quot;Atom Feed&quot;&gt;
   &lt;/a&gt;
 &lt;/div&gt;
 
diff --git a/theme/includes.tmpl b/theme/includes.tmpl
index a43ffda..19b5122 100644
--- a/theme/includes.tmpl
+++ b/theme/includes.tmpl
@@ -1,9 +1,9 @@
 {{define &quot;navbar&quot;}}
-&lt;link rel=&quot;stylesheet&quot; href=&quot;{{.Site.HomePath}}_theme/navbar.css&quot;&gt;
+&lt;link rel=&quot;stylesheet&quot; href=&quot;{{.Site.Root}}_theme/navbar.css&quot;&gt;
 &lt;nav&gt;
-  &lt;a href=&quot;{{.Site.HomePath}}&quot;&gt;Home&lt;/a&gt;
+  &lt;a href=&quot;{{.Site.Root}}&quot;&gt;Home&lt;/a&gt;
   {{- range .ArticlesInNav}}
-  &lt;a href=&quot;{{$.Site.HomePath}}{{.WebPath}}&quot;&gt;{{.Title}}&lt;/a&gt;
+  &lt;a href=&quot;{{$.Site.Root}}{{.WebPath}}&quot;&gt;{{.Title}}&lt;/a&gt;
   {{- end}}
 
   {{- if not .Post.PostedAt.IsZero}}
diff --git a/www/_theme/base.tmpl b/www/_theme/base.tmpl
index 6edbe18..5792618 100644
--- a/www/_theme/base.tmpl
+++ b/www/_theme/base.tmpl
@@ -6,7 +6,7 @@
   &lt;title&gt;{{.Title}}&lt;/title&gt;
   &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
   &lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom feed&quot; href=&quot;{{.Feed}}&quot;&gt;
-  &lt;link rel=&quot;stylesheet&quot; href=&quot;{{.Site.HomePath}}_theme/base.css&quot;&gt;
+  &lt;link rel=&quot;stylesheet&quot; href=&quot;{{.Site.Root}}_theme/base.css&quot;&gt;
   {{- template &quot;head&quot; .}}
 &lt;/head&gt;
 
diff --git a/www/_theme/home.tmpl b/www/_theme/home.tmpl
index a928083..d2b8297 100644
--- a/www/_theme/home.tmpl
+++ b/www/_theme/home.tmpl
@@ -9,12 +9,12 @@
 &lt;hr&gt;
 
 &lt;div class=&quot;pages&quot;&gt;
-  &lt;a href=&quot;{{.Site.HomePath}}&quot;&gt;Home&lt;/a&gt;
+  &lt;a href=&quot;{{.Site.Root}}&quot;&gt;Home&lt;/a&gt;
 {{- range .ArticlesInNav}}
   &lt;a href=&quot;{{.WebPath}}&quot;&gt;{{.Title}}&lt;/a&gt;
 {{- end}}
   &lt;a class=&quot;feed-link&quot; href=&quot;{{.Feed}}&quot;&gt;
-    &lt;img src=&quot;{{.Site.HomePath}}_theme/feed.svg&quot; alt=&quot;Atom Feed&quot; title=&quot;Atom Feed&quot;&gt;
+    &lt;img src=&quot;{{.Site.Root}}_theme/feed.svg&quot; alt=&quot;Atom Feed&quot; title=&quot;Atom Feed&quot;&gt;
   &lt;/a&gt;
 &lt;/div&gt;
 
diff --git a/www/_theme/includes.tmpl b/www/_theme/includes.tmpl
index a43ffda..19b5122 100644
--- a/www/_theme/includes.tmpl
+++ b/www/_theme/includes.tmpl
@@ -1,9 +1,9 @@
 {{define &quot;navbar&quot;}}
-&lt;link rel=&quot;stylesheet&quot; href=&quot;{{.Site.HomePath}}_theme/navbar.css&quot;&gt;
+&lt;link rel=&quot;stylesheet&quot; href=&quot;{{.Site.Root}}_theme/navbar.css&quot;&gt;
 &lt;nav&gt;
-  &lt;a href=&quot;{{.Site.HomePath}}&quot;&gt;Home&lt;/a&gt;
+  &lt;a href=&quot;{{.Site.Root}}&quot;&gt;Home&lt;/a&gt;
   {{- range .ArticlesInNav}}
-  &lt;a href=&quot;{{$.Site.HomePath}}{{.WebPath}}&quot;&gt;{{.Title}}&lt;/a&gt;
+  &lt;a href=&quot;{{$.Site.Root}}{{.WebPath}}&quot;&gt;{{.Title}}&lt;/a&gt;
   {{- end}}
 
   {{- if not .Post.PostedAt.IsZero}}
diff --git a/www/about/index.html b/www/about/index.html
index 0ba1993..a7ea93a 100644
--- a/www/about/index.html
+++ b/www/about/index.html
@@ -5,16 +5,16 @@
   &lt;meta charset=&quot;utf-8&quot; /&gt;
   &lt;title&gt;About | CoolZone&lt;/title&gt;
   &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
-  &lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom feed&quot; href=&quot;/feed.xml&quot;&gt;
-  &lt;link rel=&quot;stylesheet&quot; href=&quot;/_theme/base.css&quot;&gt;
+  &lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom feed&quot; href=&quot;/webmaker2000/feed.xml&quot;&gt;
+  &lt;link rel=&quot;stylesheet&quot; href=&quot;/webmaker2000/_theme/base.css&quot;&gt;
 &lt;/head&gt;
 
 &lt;body&gt;
 
-&lt;link rel=&quot;stylesheet&quot; href=&quot;/_theme/navbar.css&quot;&gt;
+&lt;link rel=&quot;stylesheet&quot; href=&quot;/webmaker2000/_theme/navbar.css&quot;&gt;
 &lt;nav&gt;
-  &lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;
-  &lt;a href=&quot;/about/&quot;&gt;About&lt;/a&gt;
+  &lt;a href=&quot;/webmaker2000/&quot;&gt;Home&lt;/a&gt;
+  &lt;a href=&quot;/webmaker2000/about/&quot;&gt;About&lt;/a&gt;
 
 &lt;/nav&gt;
 &lt;hr class=&quot;nav-hr&quot;&gt;
diff --git a/www/feed.xml b/www/feed.xml
index 9f59f07..4852045 100644
--- a/www/feed.xml
+++ b/www/feed.xml
@@ -1,7 +1,7 @@
 &lt;feed xmlns=&quot;http://www.w3.org/2005/Atom&quot;&gt;
   &lt;title&gt;CoolZone&lt;/title&gt;
   &lt;id&gt;https://coolzone.example.com/&lt;/id&gt;
-  &lt;link rel=&quot;self&quot; href=&quot;/feed.xml&quot;&gt;&lt;/link&gt;
+  &lt;link rel=&quot;self&quot; href=&quot;/webmaker2000/feed.xml&quot;&gt;&lt;/link&gt;
   &lt;updated&gt;2023-04-05T00:00:00+07:00&lt;/updated&gt;
   &lt;author&gt;
     &lt;name&gt;Coolio McCool&lt;/name&gt;
diff --git a/www/index.html b/www/index.html
index 5d0ee5d..df81f2b 100644
--- a/www/index.html
+++ b/www/index.html
@@ -5,8 +5,8 @@
   &lt;meta charset=&quot;utf-8&quot; /&gt;
   &lt;title&gt;CoolZone - Cool people only.&lt;/title&gt;
   &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
-  &lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom feed&quot; href=&quot;/feed.xml&quot;&gt;
-  &lt;link rel=&quot;stylesheet&quot; href=&quot;/_theme/base.css&quot;&gt;
+  &lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom feed&quot; href=&quot;/webmaker2000/feed.xml&quot;&gt;
+  &lt;link rel=&quot;stylesheet&quot; href=&quot;/webmaker2000/_theme/base.css&quot;&gt;
 &lt;/head&gt;
 
 &lt;body&gt;
@@ -19,10 +19,10 @@ &lt;h1 class=&quot;site-title&quot;&gt;CoolZone&lt;/h1&gt;
 &lt;hr&gt;
 
 &lt;div class=&quot;pages&quot;&gt;
-  &lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;
+  &lt;a href=&quot;/webmaker2000/&quot;&gt;Home&lt;/a&gt;
   &lt;a href=&quot;about/&quot;&gt;About&lt;/a&gt;
-  &lt;a class=&quot;feed-link&quot; href=&quot;/feed.xml&quot;&gt;
-    &lt;img src=&quot;/_theme/feed.svg&quot; alt=&quot;Atom Feed&quot; title=&quot;Atom Feed&quot;&gt;
+  &lt;a class=&quot;feed-link&quot; href=&quot;/webmaker2000/feed.xml&quot;&gt;
+    &lt;img src=&quot;/webmaker2000/_theme/feed.svg&quot; alt=&quot;Atom Feed&quot; title=&quot;Atom Feed&quot;&gt;
   &lt;/a&gt;
 &lt;/div&gt;
 
diff --git a/www/mfws.html b/www/mfws.html
index cc7abef..a45d28d 100644
--- a/www/mfws.html
+++ b/www/mfws.html
@@ -5,16 +5,16 @@
   &lt;meta charset=&quot;utf-8&quot; /&gt;
   &lt;title&gt;This is a motherfucking website. | CoolZone&lt;/title&gt;
   &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
-  &lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom feed&quot; href=&quot;/feed.xml&quot;&gt;
-  &lt;link rel=&quot;stylesheet&quot; href=&quot;/_theme/base.css&quot;&gt;
+  &lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom feed&quot; href=&quot;/webmaker2000/feed.xml&quot;&gt;
+  &lt;link rel=&quot;stylesheet&quot; href=&quot;/webmaker2000/_theme/base.css&quot;&gt;
 &lt;/head&gt;
 
 &lt;body&gt;
 
-&lt;link rel=&quot;stylesheet&quot; href=&quot;/_theme/navbar.css&quot;&gt;
+&lt;link rel=&quot;stylesheet&quot; href=&quot;/webmaker2000/_theme/navbar.css&quot;&gt;
 &lt;nav&gt;
-  &lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;
-  &lt;a href=&quot;/about/&quot;&gt;About&lt;/a&gt;
+  &lt;a href=&quot;/webmaker2000/&quot;&gt;Home&lt;/a&gt;
+  &lt;a href=&quot;/webmaker2000/about/&quot;&gt;About&lt;/a&gt;
   &lt;span class=&quot;posted-on&quot;&gt;
     Posted on
     &lt;time datetime=&quot;2023-04-05&quot;&gt;
diff --git a/www/scale/index.html b/www/scale/index.html
index 882841b..c22f440 100644
--- a/www/scale/index.html
+++ b/www/scale/index.html
@@ -5,16 +5,16 @@
   &lt;meta charset=&quot;utf-8&quot; /&gt;
   &lt;title&gt;I&amp;#39;m Going To Scale My Foot Up Your Ass | CoolZone&lt;/title&gt;
   &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt;
-  &lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom feed&quot; href=&quot;/feed.xml&quot;&gt;
-  &lt;link rel=&quot;stylesheet&quot; href=&quot;/_theme/base.css&quot;&gt;
+  &lt;link rel=&quot;alternate&quot; type=&quot;application/atom+xml&quot; title=&quot;Atom feed&quot; href=&quot;/webmaker2000/feed.xml&quot;&gt;
+  &lt;link rel=&quot;stylesheet&quot; href=&quot;/webmaker2000/_theme/base.css&quot;&gt;
 &lt;/head&gt;
 
 &lt;body&gt;
 &lt;div class=&quot;navbar-container&quot;&gt;
-&lt;link rel=&quot;stylesheet&quot; href=&quot;/_theme/navbar.css&quot;&gt;
+&lt;link rel=&quot;stylesheet&quot; href=&quot;/webmaker2000/_theme/navbar.css&quot;&gt;
 &lt;nav&gt;
-  &lt;a href=&quot;/&quot;&gt;Home&lt;/a&gt;
-  &lt;a href=&quot;/about/&quot;&gt;About&lt;/a&gt;
+  &lt;a href=&quot;/webmaker2000/&quot;&gt;Home&lt;/a&gt;
+  &lt;a href=&quot;/webmaker2000/about/&quot;&gt;About&lt;/a&gt;
   &lt;span class=&quot;posted-on&quot;&gt;
     Posted on
     &lt;time datetime=&quot;2008-04-24&quot;&gt;
diff --git a/www/website.wbmkr2k b/www/website.wbmkr2k
index 9bd2671..c67de7c 100644
--- a/www/website.wbmkr2k
+++ b/www/website.wbmkr2k
@@ -1,6 +1,7 @@
 Address: https://coolzone.example.com
 Name: CoolZone
 Tagline: Cool people only.
+Root: /webmaker2000/
 
 AuthorName: Coolio McCool
 AuthorURI: https://author.example.com
</pre></body></html>