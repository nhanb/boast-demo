<!DOCTYPE html>
<html lang="en" style="font-family: monospace;"><head><title>[7f6cdad769] protect scheduler against exceptions | pytaku | Boast</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"></head><body><strong><a href="../../">Repos</a> / <a href="../">pytaku</a> / 7f6cdad769</strong><hr><pre>commit 7f6cdad769ce2d3eb19f4a2a14f1b5bca158241e
Author: Bùi Thành Nhân &lt;hi@imnhan.com&gt;
Date:   Sat Aug 29 15:43:06 2020 +0700

    protect scheduler against exceptions
    
    A failed worker is now put back into the queue, for a maximum of 3
    retries before its current turn is skipped.
    
    Also, in the update title worker: just skip title if source site is
    currently acting up.

diff --git a/pyproject.toml b/pyproject.toml
index 54f5d77..f71d4ea 100644
--- a/pyproject.toml
+++ b/pyproject.toml
@@ -1,6 +1,6 @@
 [tool.poetry]
 name = &quot;pytaku&quot;
-version = &quot;0.3.9&quot;
+version = &quot;0.3.10&quot;
 description = &quot;Self-hostable web-based manga reader&quot;
 authors = [&quot;Bùi Thành Nhân &lt;hi@imnhan.com&gt;&quot;]
 license = &quot;AGPL-3.0-only&quot;
diff --git a/src/pytaku/scheduler.py b/src/pytaku/scheduler.py
index 1617c8d..c64cb21 100644
--- a/src/pytaku/scheduler.py
+++ b/src/pytaku/scheduler.py
@@ -1,8 +1,13 @@
 import time
+import traceback
 from abc import ABC, abstractmethod
 from datetime import datetime, timedelta
 from pathlib import Path
 
+from requests.exceptions import ReadTimeout
+
+from mangoapi.exceptions import SourceSite5xxError
+
 from .conf import config
 from .persistence import delete_expired_tokens, find_outdated_titles, save_title
 from .source_sites import get_title
@@ -17,8 +22,13 @@ def main_loop():
         for worker in workers:
             if worker.should_run():
                 print(&quot;Running&quot;, worker.__class__.__name__)
-                worker.run()
-                worker.after_run()
+                try:
+                    worker.run()
+                    worker.after_run()
+                except Exception:
+                    stacktrace = traceback.format_exc()
+                    print(stacktrace)
+                    worker.after_error(stacktrace)
         time.sleep(5)
 
 
@@ -27,6 +37,7 @@ class Worker(ABC):
 
     def __init__(self):
         self.last_run = datetime(1, 1, 1)
+        self.error_count = 0
 
     def should_run(self):
         return now() - self.last_run &gt;= self.interval
@@ -38,6 +49,15 @@ def run(self):
     def after_run(self):
         self.last_run = now()
 
+    def after_error(self, stacktrace):
+        # TODO: email or send stacktrace to an ops chat channel or something
+        self.error_count += 1
+
+        # If failed repeatedly: give up this run
+        if self.error_count &gt; 3:
+            self.last_run = now()
+            self.error_count = 0
+
 
 class UpdateOutdatedTitles(Worker):
     interval = timedelta(hours=2)
@@ -45,9 +65,12 @@ class UpdateOutdatedTitles(Worker):
     def run(self):
         for title in find_outdated_titles():
             print(f&quot;Updating title {title[&#39;id&#39;]} from {title[&#39;site&#39;]}...&quot;, end=&quot;&quot;)
-            updated_title = get_title(title[&quot;site&quot;], title[&quot;id&quot;])
-            save_title(updated_title)
-            print(&quot; done&quot;)
+            try:
+                updated_title = get_title(title[&quot;site&quot;], title[&quot;id&quot;])
+                save_title(updated_title)
+                print(&quot; done&quot;)
+            except (SourceSite5xxError, ReadTimeout) as e:
+                print(&quot; skipped because of server error:&quot;, str(e))
 
 
 class DeleteExpiredTokens(Worker):
</pre></body></html>