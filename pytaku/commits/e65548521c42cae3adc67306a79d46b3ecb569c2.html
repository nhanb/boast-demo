<!DOCTYPE html>
<html lang="en" style="font-family: monospace;"><head><title>[e65548521c] cope with CF failures by refreshing session | pytaku | Boast</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"></head><body><strong><a href="../../">Repos</a> / <a href="../">pytaku</a> / e65548521c</strong><hr><pre>commit e65548521c42cae3adc67306a79d46b3ecb569c2
Author: Bùi Thành Nhân &lt;hi@imnhan.com&gt;
Date:   Tue Jun 15 23:37:45 2021 +0700

    cope with CF failures by refreshing session

diff --git a/src/mangoapi/base_site.py b/src/mangoapi/base_site.py
index b3a6479..08f4332 100644
--- a/src/mangoapi/base_site.py
+++ b/src/mangoapi/base_site.py
@@ -11,12 +11,20 @@
 )
 
 
+def create_session():
+    return cloudscraper.create_scraper(
+        {
+            &quot;mobile&quot;: False,
+        }
+    )
+
+
 class Site(ABC):
     def __init__(self):
         self.username = None
         self.password = None
         self.is_logged_in = False
-        self._session = cloudscraper.create_scraper(browser=&quot;chrome&quot;)
+        self._session = create_session()
 
     @abstractmethod
     def get_title(self, title_id):
@@ -47,16 +55,18 @@ def login(self, username, password):
         raise NotImplementedError()
 
     def _http_request(self, method, url, *args, **kwargs):
-        request_func = getattr(self._session, method)
-
         if &quot;timeout&quot; not in kwargs:
             kwargs[&quot;timeout&quot;] = 5
 
+        request_func = getattr(self._session, method)
         try:
             resp = request_func(url, *args, **kwargs)
         except requests.exceptions.Timeout:
             raise SourceSiteTimeoutError(url)
 
+        if resp.status_code == 403:
+            self._session = create_session()
+
         if 500 &lt;= resp.status_code &lt;= 599:
             raise SourceSite5xxError(url, resp.status_code, resp.text)
         elif resp.status_code != 200:
diff --git a/src/pytaku/scheduler.py b/src/pytaku/scheduler.py
index e56c340..c8dff33 100644
--- a/src/pytaku/scheduler.py
+++ b/src/pytaku/scheduler.py
@@ -1,3 +1,4 @@
+import random
 import time
 import traceback
 from abc import ABC, abstractmethod
@@ -66,7 +67,7 @@ class UpdateOutdatedTitles(Worker):
     def run(self):
         for title in find_outdated_titles():
             if title[&quot;site&quot;] == &quot;mangadex&quot;:
-                print(f&quot;Skipped title {title[&#39;id&#39;]} from {title[&#39;site&#39;]}.&quot;)
+                # print(f&quot;Skipped title {title[&#39;id&#39;]} from {title[&#39;site&#39;]}.&quot;)
                 continue
 
             print(f&quot;Updating title {title[&#39;id&#39;]} from {title[&#39;site&#39;]}...&quot;, end=&quot;&quot;)
@@ -74,6 +75,8 @@ def run(self):
                 updated_title = get_title(title[&quot;site&quot;], title[&quot;id&quot;])
                 save_title(updated_title)
                 print(&quot; done&quot;)
+                if title[&quot;site&quot;] == &quot;mangasee&quot;:
+                    time.sleep(random.randint(5, 10))
             except (SourceSite5xxError, ReadTimeout, JSONDecodeError) as e:
                 print(&quot; skipped because of server error:&quot;, e.__class__.__name__, str(e))
 
</pre></body></html>