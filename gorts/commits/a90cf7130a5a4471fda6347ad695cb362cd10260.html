<!DOCTYPE html>
<html lang="en" style="font-family: monospace;"><head><title>[a90cf7130a] simplify readstate too | gorts | Boast</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"></head><body><strong><a href="../../">Repos</a> / <a href="../">gorts</a> / a90cf7130a</strong><hr><pre>commit a90cf7130a5a4471fda6347ad695cb362cd10260
Author: Nh√¢n &lt;hi@imnhan.com&gt;
Date:   Fri Jun 16 23:31:18 2023 +0700

    simplify readstate too

diff --git a/.gitignore b/.gitignore
index 9b1c8b1..58c4c79 100644
--- a/.gitignore
+++ b/.gitignore
@@ -1 +1,2 @@
 /dist
+/web/state.json
diff --git a/main.go b/main.go
index f49a57f..8074cc1 100644
--- a/main.go
+++ b/main.go
@@ -71,34 +71,35 @@ func connectTclProc() {
 	io.WriteString(stdin, &quot;readstate\n&quot;)
 
 	scanner := bufio.NewScanner(stdout)
+
+	next := func() string {
+		scanner.Scan()
+		v := scanner.Text()
+		println(&quot;=&gt;&quot;, v)
+		return v
+	}
+
+	respond := func(s string) {
+		println(&quot;&lt;=&quot;, s)
+		io.WriteString(stdin, s+&quot;\n&quot;)
+	}
+
 	for scanner.Scan() {
 		req := scanner.Text()
 		println(&quot;=&gt; &quot; + req)
 		switch req {
 		case &quot;readstate&quot;:
-			for _, line := range []string{
-				&quot;description &quot; + state.Description,
-				&quot;p1name &quot; + state.P1name,
-				&quot;p1country &quot; + state.P1country,
-				&quot;p1score &quot; + strconv.Itoa(state.P1score),
-				&quot;p1team &quot; + state.P1team,
-				&quot;p2name &quot; + state.P2name,
-				&quot;p2country &quot; + state.P2country,
-				&quot;p2score &quot; + strconv.Itoa(state.P2score),
-				&quot;p2team &quot; + state.P2team,
-				&quot;end&quot;,
-			} {
-				println(&quot;&lt;= &quot; + line)
-				io.WriteString(stdin, line+&quot;\n&quot;)
-			}
-		case &quot;applystate&quot;:
-			next := func() string {
-				scanner.Scan()
-				v := scanner.Text()
-				println(&quot;=&gt;&quot;, v)
-				return v
-			}
 			// TODO: there must be more... civilized way.
+			respond(state.Description)
+			respond(state.P1name)
+			respond(state.P1country)
+			respond(strconv.Itoa(state.P1score))
+			respond(state.P1team)
+			respond(state.P2name)
+			respond(state.P2country)
+			respond(strconv.Itoa(state.P2score))
+			respond(state.P2team)
+		case &quot;applystate&quot;:
 			state.Description = next()
 			state.P1name = next()
 			state.P1country = next()
diff --git a/tcl/main.tcl b/tcl/main.tcl
index 593a6bf..7830595 100644
--- a/tcl/main.tcl
+++ b/tcl/main.tcl
@@ -78,30 +78,26 @@ grid columnconfigure .c.buttons 3 -pad 15
 
 # Very simple line-based IPC where Tcl client talks to Go server
 # via stdin/stdout.
-#
-# For this &quot;readstate&quot; method, the Go server returns multiple lines
-# where each line starts with variable name, followed by a space,
-# with the rest of the line being its value. When done, the server
-# sends a literal &quot;end&quot; line.
-#
-# =&gt; readstate
-# &lt;= description Saigon Cup 2023
-# &lt;= p1name BST Diego Umejuarez
-# &lt;= p1score 0
-# [etc.]
-# &lt;= end
 proc readstate {} {
     puts &quot;readstate&quot;
-    set line [gets stdin]
-    while {$line != &quot;end&quot;} {
-        set spaceindex [string first &quot; &quot; $line]
-        set key [string range $line 0 $spaceindex-1]
-        set val [string range $line $spaceindex+1 end]
-        # this makes sure it sets the outer scope&#39;s variable:
-        variable ${key}
-        set ${key} $val
-        set line [gets stdin]
-    }
+    variable description
+    variable p1name
+    variable p1country
+    variable p1score
+    variable p1team
+    variable p2name
+    variable p2country
+    variable p2score
+    variable p2team
+    set description [gets stdin]
+    set p1name [gets stdin]
+    set p1country [gets stdin]
+    set p1score [gets stdin]
+    set p1team [gets stdin]
+    set p2name [gets stdin]
+    set p2country [gets stdin]
+    set p2score [gets stdin]
+    set p2team [gets stdin]
 }
 
 proc applystate {} {
diff --git a/web/state.json b/web/state.sample.json
similarity index 91%
rename from web/state.json
rename to web/state.sample.json
index 6358e75..1223710 100644
--- a/web/state.json
+++ b/web/state.sample.json
@@ -2,10 +2,10 @@
     &quot;description&quot;: &quot;Saigon Cup 2023&quot;,
     &quot;p1name&quot;: &quot;BST CYG Diego Umejuarez&quot;,
     &quot;p1country&quot;: &quot;jp&quot;,
+    &quot;p1score&quot;: 10,
     &quot;p1team&quot;: &quot;Team Japan&quot;,
-    &quot;p1score&quot;: 6,
     &quot;p2name&quot;: &quot;Jiyuner&quot;,
     &quot;p2country&quot;: &quot;us&quot;,
     &quot;p2score&quot;: 1,
     &quot;p2team&quot;: &quot;Team Japan2&quot;
-}
+}
\ No newline at end of file
</pre></body></html>