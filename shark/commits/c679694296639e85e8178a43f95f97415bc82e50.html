<!DOCTYPE html>
<html lang="en" style="font-family: monospace;"><head><title>[c679694296] github actions: separate build for each OS | shark | Boast</title><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"></head><body><strong><a href="../../">Repos</a> / <a href="../">shark</a> / c679694296</strong><hr><pre>commit c679694296639e85e8178a43f95f97415bc82e50
Author: Nh√¢n &lt;hi@imnhan.com&gt;
Date:   Sun Jul 10 15:33:32 2022 +0700

    github actions: separate build for each OS
    
    It&#39;s dumber but also clearer. I&#39;m sick of debugging dumb GH Action
    mistakes.

diff --git a/.github/workflows/main.yml b/.github/workflows/main.yml
index b339dfc..a40ebb4 100644
--- a/.github/workflows/main.yml
+++ b/.github/workflows/main.yml
@@ -5,13 +5,8 @@ on:
 
 jobs:
 
-  build-everything:
-
-    strategy:
-      matrix:
-        os: [ubuntu-latest, macos-10.15]
-
-    runs-on: ${{ matrix.os }}
+  build-linux:
+    runs-on: ubuntu-latest
 
     steps:
     - uses: actions/checkout@v3
@@ -20,32 +15,63 @@ jobs:
         go-version: 1.18
 
     - name: Install ebiten linux deps
-      if: runner.os == &#39;Linux&#39;
       run: make deps-debian
 
-    - name: Build for ${{ runner.os }}
+    - name: Build for Linux
       env:
           TAG: ${{ github.ref_name }}
-      run: make $(echo ${{ runner.os }} | tr &#39;[:upper:]&#39; &#39;[:lower:]&#39;)
-      # The `tr` stuff is to convert the string to lowercase
+      run: make linux
 
     - name: Zip first to prevent GH Artifacts from removing the executable flag
       run: |
         cd dist
-        zip -vr &quot;shark-${{ runner.os }}.zip&quot; .
+        zip -vr &quot;shark-linux.zip&quot; .
 
-    - name: Upload ${{ runner.os }} build
+    - name: Upload linux build
       uses: actions/upload-artifact@v3
       with:
-        name: ${{ runner.os }} shark
-        path: dist/shark-${{ runner.os }}.zip
+        name: Linux shark
+        path: dist/shark-linux.zip
 
-    - name: Cross-compile Windows build
+    - name: Upload artifacts to tagged release
+      if: github.ref_type == &#39;tag&#39;
+      env:
+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
+          TAG: ${{ github.ref_name }}
+      run: |
+        # Because we have multiple OSes in the build matrix, we need to either
+        # create a new release, or upload to the release if it already exists.
+        if gh release view &quot;$TAG&quot;; then
+          gh release upload &quot;$TAG&quot; dist/*.zip
+        else
+          # Work around GH being daft:
+          # https://github.com/actions/checkout/issues/290
+          git fetch --force --tags
+
+          echo &#39;```&#39; &gt; RELEASE_NOTES
+          git tag -l --format=&#39;%(contents)&#39; &quot;$TAG&quot; &gt;&gt; RELEASE_NOTES
+          echo &#39;```&#39; &gt;&gt; RELEASE_NOTES
+          cat RELEASE_NOTES
+          gh release create &quot;$TAG&quot; dist/*.zip -F RELEASE_NOTES
+        fi
+
+  build-windows:
+    runs-on: ubuntu-latest
+
+    steps:
+    - uses: actions/checkout@v3
+    - uses: actions/setup-go@v3
+      with:
+        go-version: 1.18
+
+    - name: Install ebiten linux deps
       if: runner.os == &#39;Linux&#39;
+      run: make deps-debian
+
+    - name: Cross-compile Windows build
       run: make windows
 
     - name: Upload cross-compiled Windows build
-      if: runner.os == &#39;Linux&#39;
       uses: actions/upload-artifact@v3
       with:
         name: Windows shark
@@ -60,7 +86,54 @@ jobs:
         # Because we have multiple OSes in the build matrix, we need to either
         # create a new release, or upload to the release if it already exists.
         if gh release view &quot;$TAG&quot;; then
-          gh release upload &quot;$TAG&quot; dist/*.zip dist/*.exe
+          gh release upload &quot;$TAG&quot; dist/*.exe
+        else
+          # Work around GH being daft:
+          # https://github.com/actions/checkout/issues/290
+          git fetch --force --tags
+
+          echo &#39;```&#39; &gt; RELEASE_NOTES
+          git tag -l --format=&#39;%(contents)&#39; &quot;$TAG&quot; &gt;&gt; RELEASE_NOTES
+          echo &#39;```&#39; &gt;&gt; RELEASE_NOTES
+          cat RELEASE_NOTES
+          gh release create &quot;$TAG&quot; dist/*.exe -F RELEASE_NOTES
+        fi
+
+  build-macos:
+    runs-on: macos-10.15
+
+    steps:
+    - uses: actions/checkout@v3
+    - uses: actions/setup-go@v3
+      with:
+        go-version: 1.18
+
+    - name: Build for macOS
+      env:
+          TAG: ${{ github.ref_name }}
+      run: make macos
+
+    - name: Zip first to prevent GH Artifacts from removing the executable flag
+      run: |
+        cd dist
+        zip -vr &quot;shark-macos.zip&quot; .
+
+    - name: Upload macOS build
+      uses: actions/upload-artifact@v3
+      with:
+        name: macOS shark
+        path: dist/shark-macos.zip
+
+    - name: Upload artifacts to tagged release
+      if: github.ref_type == &#39;tag&#39;
+      env:
+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
+          TAG: ${{ github.ref_name }}
+      run: |
+        # Because we have multiple OSes in the build matrix, we need to either
+        # create a new release, or upload to the release if it already exists.
+        if gh release view &quot;$TAG&quot;; then
+          gh release upload &quot;$TAG&quot; dist/*.zip
         else
           # Work around GH being daft:
           # https://github.com/actions/checkout/issues/290
@@ -70,5 +143,5 @@ jobs:
           git tag -l --format=&#39;%(contents)&#39; &quot;$TAG&quot; &gt;&gt; RELEASE_NOTES
           echo &#39;```&#39; &gt;&gt; RELEASE_NOTES
           cat RELEASE_NOTES
-          gh release create &quot;$TAG&quot; dist/*.zip dist/*.exe -F RELEASE_NOTES
+          gh release create &quot;$TAG&quot; dist/*.zip -F RELEASE_NOTES
         fi
</pre></body></html>